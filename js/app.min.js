var app=angular.module("app",["ngStorage"]);app.controller("home",function(a,t,e){this.data=[],this.home=[],this.away=[],this.temp=[],this.arrows=[],this.planSheet=["3-5-2","3-4-3","4-4-2","4-3-3","4-4-1-1","4-1-4-1","4-2-3-1","4-3-2-1","4-1-3-2","5-3-2","5-4-1"],this.toggleMenuBar=!1,this.flag_attack=0,this.ball={position:{top:"49%",left:"calc(50% - 15px)"}},this.isMobile=null!=new MobileDetect(window.navigator.userAgent).mobile(),init=(async()=>{console.log(e.profiles),this.profiles=e.profiles||[],this.profileRecent=e.recentName||"./json/default.json",await this.load(this.profileRecent),await this.draw()}),this.loadUrl=(async a=>{const e=btoa(a);await t.get("https://iboommm.com:6060/livescore/"+e).then(a=>{console.log(a.data);const t=a.data;let e=_.compact(t.Lu[0].Ps.map(a=>{if("SUBSTITUTE_PLAYER"!=a.Pon&&"COACH"!=a.Pon)return{name:a.Shnm,number:a.Snu}})),s=_.compact(t.Lu[0].Ps.map(a=>{if("SUBSTITUTE_PLAYER"==a.Pon)return{name:a.Shnm,number:a.Snu}})),o=_.compact(t.Lu[1].Ps.map(a=>{if("SUBSTITUTE_PLAYER"!=a.Pon&&"COACH"!=a.Pon)return{name:a.Shnm,number:a.Snu}})),l=_.compact(t.Lu[1].Ps.map(a=>{if("SUBSTITUTE_PLAYER"==a.Pon)return{name:a.Shnm,number:a.Snu}}));e=this.processLineUp(t.Lu[0].Fo.join("-"),e),o=(o=this.processLineUp(t.Lu[1].Fo.join("-"),o)).map(a=>a.reverse());let i={teamHome:{name:t.T1[0].Nm,plan:t.Lu[0].Fo.join("-"),players:e,subs:s},teamAway:{name:t.T2[0].Nm,plan:t.Lu[1].Fo.join("-"),players:o,subs:l}};this.temp=i,this.data=i,this.arrows=[],this.draw()}).catch(a=>console.log(a))}),this.processLineUp=((a,t)=>{let e=a.split("-").map(a=>parseInt(a)),s=0,o=_.clone(t).map((a,o)=>{if(0==o)return[{...a}];{let a=[];s+=e[0];for(let o=0;o<e[0];o++)a.push({...t[s+o-e[0]+1]});return e.shift(),a}});return _.compact(_.map(o,a=>a.length>0&&a))}),this.load=(async e=>{await t.get(e).then(t=>{this.data=t.data,this.temp=_.clone(t.data),a.$applyAsync()}).catch(a=>console.log(a))}),this.loadTemplate=(async a=>{await this.load(a),await this.draw(),e.recentName=a,$("#loadTemplate").modal("hide")}),this.loadTemplateByCache=(t=>{this.data=_.clone(t.data),console.log(t.data),"ball"in this.data&&($(".ball").css(this.data.ball.position),console.log("loaded ball")),"arrows"in this.data&&(this.arrows=_.clone(this.data.arrows),console.log("loaded arrows"),this.arrows.forEach((a,t)=>{setTimeout(()=>{const e=a.position2.transform.match(/[-]{0,1}[\d]*[.]{0,1}[\d]+/g,"")[0];console.log(e),$(".arrow-"+t+"> .arrow-rotate").rotatable({stop:handleArrowDragStop,angle:parseFloat(e)}),$(".arrow-"+t).draggable({stop:handleArrowDragStop})},200)})),a.$applyAsync(),this.draw(),$("#loadTemplate").modal("hide")}),this.reset=(()=>{this.data=_.clone(this.temp),$(".ball").css({top:"49%",left:"calc(50% - 15px)"}),a.$applyAsync(),this.draw(),this.arrows=[]}),this.swap=(()=>{this.data={teamHome:_.clone(this.temp).teamAway,teamAway:_.clone(this.temp).teamHome},this.draw()}),this.arrowMenu=!1,this.toggleArrowMenu=(()=>{this.toolsMenu=!1,this.arrowMenu=!this.arrowMenu}),this.loadTemplatePopup=(()=>{$("#loadTemplate").modal()}),this.templateNameCache="",this.saveTemplatePopup=(()=>{$("#saveTemplate").modal()}),this.loadLineUpPopup=(()=>{$("#loadLineUp").modal()}),this.urlLineup="",this.importLineup=(async()=>{await this.loadUrl(this.urlLineup),$("#loadLineUp").modal("hide")}),this.saveTemplateConfirm=(()=>{const a=JSON.parse(angular.toJson(this.getPlanLineUp("home"))),t=JSON.parse(angular.toJson(this.getPlanLineUp("away"))),s={teamHome:{name:this.home.name,plan:this.home.plan,players:a,subs:this.home.subs},teamAway:{name:this.away.name,plan:this.away.plan,players:t,subs:this.away.subs},ball:{...this.ball},arrows:this.arrows};"object"!=typeof e.profiles&&(e.profiles=[]),e.profiles.push({name:this.templateNameCache,data:s}),this.templateNameCache="",$("#saveTemplate").modal("hide")}),this.toolsMenu=!1,this.toggleToolsMenu=(()=>{this.arrowMenu=!1,this.toolsMenu=!this.toolsMenu}),this.addArrow=(a=>{const t=Math.floor(160*Math.random())+31;console.log(t),this.arrows.push({mode:a,position:{left:t+"px",top:"529px",transform:"rotate(1.07174rad)"}}),setTimeout(()=>{$(".arrow-rotate").rotatable({stop:handleArrowDragStop}),$(".arrow").draggable({stop:handleArrowDragStop})},200)}),this.removeArrow=(a=>{_.remove(this.arrows,t=>t===a)}),this.removeData=((a,t)=>{_.remove(a,a=>a==t)}),this.draw=(async(t="normal",e={side:"",value:"",players:[]})=>{this.home.players="home"==e.side&&e.players.length>0?e.players:Object.values(this.data.teamHome.players),this.home.plan="home"==e.side&&""!=e.value?e.value:this.data.teamHome.plan,this.home.subs=this.data.teamHome.subs,this.home.name=this.data.teamHome.name,delete this.home.players.$$hashKey;let s=[];s=this.home.players.length>4?this.drawPlayer(!0,!0,t):this.drawPlayer(!0,!1,t),this.away.players="away"==e.side&&e.players.length>0?e.players:Object.values(this.data.teamAway.players),this.away.plan="away"==e.side&&""!=e.value?e.value:this.data.teamAway.plan,this.away.subs=this.data.teamAway.subs,this.away.name=this.data.teamAway.name,delete this.away.players.$$hashKey;let o=[];o=this.away.players.length>4?this.drawPlayer(!1,!0,t):this.drawPlayer(!1,!1,t),this.home.players=s,this.away.players=o,await a.$applyAsync(),setTimeout(()=>{$(".player").draggable({containment:"#container-field",cursor:"move",snap:"#container-field",stop:handleDragStop}),console.log("set dragable for player")},200)}),this.drawPlayer=((a,t,e="")=>{let s=a?this.home:this.away;console.log("temp",s);let o=9,l=[],i=0;"attack"==e&&a&&!t&&(o=16),"attack"==e&&a&&t&&(o=18),"attack"!=e||a||(o=9),"attack"==e&&!a&&t&&(o=8);const r=a?5:90;for(role of s.players)if(0==i++)l.push({...role[0],position:role[0].position?role[0].position:{top:r+"%",left:"calc(50% - 10px)"}});else{let s=100/role.length,r=0;for(player of role){a&&console.log("role",role);let n=Math.abs((a?5:100)-i*(o*(t?1:1.15))),p=++r*s-s/2;if(player.name.split(" ").length>1){let a=player.name.substring(name.lastIndexOf(" ")+1,1);player.name=a+". "+player.name.split(" ")[1]}l.push({...player,position:""==e&&player.position?player.position:{top:n+"%",left:"calc("+p+"% - 10px)"}})}}return console.log("playerTemp",l),l}),this.changePlan=(a=>{let t=this[a].plan.split("-").map(a=>parseInt(a));console.log("change plan to",t);let e=0,s=_.clone(this[a].players).map((s,o)=>{if(0==o)return[{...s}];{let s=[];e+=t[0];for(let o=0;o<t[0];o++)s.push({...this[a].players[e+o-t[0]+1]});return t.shift(),s}});s=_.compact(_.map(s,a=>a.length>0&&a)),this.draw("normal",{side:a,value:this[a].plan,players:s})}),this.getPlanLineUp=(a=>{let t=this[a].plan.split("-").map(a=>parseInt(a)),e=0,s=_.clone(this[a].players).map((s,o)=>{if(0==o)return[{...s}];{let s=[];e+=t[0];for(let o=0;o<t[0];o++)s.push({...this[a].players[e+o-t[0]+1]});return t.shift(),s}});return _.compact(_.map(s,a=>a.length>0&&a))}),this.teamSwap=[],this.teamSwapSide="",this.teamSwapPick="",this.teamSwapKey=-1,this.swapPlayer=((a,t,e)=>{if(-1==this.teamSwapKey)this.teamSwap="home"==a?this.home:this.away,this.teamSwapSide=a,this.teamSwapPick=t,this.teamSwapKey=e;else{const a=this.teamSwap[this.teamSwapPick][this.teamSwapKey].name,s=this.teamSwap[t][e].name;this.teamSwap[this.teamSwapPick][this.teamSwapKey].name=s,this.teamSwap[t][e].name=a,this.teamSwap=[],this.teamSwapSide="",this.teamSwapPick="",this.teamSwapKey=-1}}),handleArrowDragStop=((a,t)=>{let e=_.map(_.split(a.target.outerHTML," "),a=>!!_.startsWith(a,"arrow-")&&a);try{e=_.compact(e)[1].split("-");const s=parseInt(e[1]);if("angle"in t)console.log(t.angle.current);else{const a=parseInt(t.position.left)||0,e=parseInt(t.position.top)||0;this.arrows[s].position={top:e+"px",left:a+"px",transform:t.helper[0].style.transform}}}catch(e){let s=_.compact(_.map(a.target.parentElement.classList,a=>!!_.startsWith(a,"arrow-")&&a))[1].split("-");const o=parseInt(s[1]);this.arrows[o].position2={transform:"rotate("+t.angle.current+"rad)"}}}),handleDragStop=((t,e)=>{const s=parseInt(e.position.left),o=parseInt(e.position.top);let l=_.map(_.split(t.target.outerHTML," "),a=>!!_.startsWith(a,"player")&&a);try{const a=(l=_.compact(l)[1].split("-"))[1],t=l[2];console.log("before",this[a].players[t]),this[a].players[t]={...this[a].players[t],position:{top:o+"px",left:s+"px"}}}catch(a){console.log(s,o),this.ball={position:{top:o+"px",left:s+"px"}}}a.$applyAsync()}),angular.element(document).ready(function(){setTimeout(()=>{$(".player").draggable({containment:"#container-field",cursor:"move",snap:"#container-field",stop:handleDragStop}),console.log("set dragable for player")},200),$(".ball").draggable({containment:"#container-field",cursor:"move",snap:"#container-field",stop:handleDragStop})}),init()});